name: prd-with-implementation
version: 1.0
description: |
  Create PRD and optionally implement based on user choice.
  Workflow: Requirements → PRD generation → (Optional) Figma analysis → (Optional) Implementation

phases:
  # PHASE 1: PRD GENERATION
  - id: prd_generation
    name: "PRD Generation - Create Product Requirements"
    type: processing
    tasks:
      - id: generate_prd
        agent: prd-writer
        operation: delegate
        input:
          context:
            requirements: "{{parameters.requirements}}"
        output:
          storeAs: prd

  # PHASE 2: DESIGN ANALYSIS (Optional - if Figma URLs provided)
  - id: design_analysis
    name: "Design Analysis - Extract Specs from Figma"
    type: processing
    gateCondition: "{{parameters.figmaUrls != null && parameters.figmaUrls.length > 0}}"
    errorRecovery: skip
    tasks:
      - id: analyze_designs
        agent: figma-design-analyzer
        operation: delegate
        parallel: true
        input:
          context:
            figmaUrls: "{{parameters.figmaUrls}}"
            prd: "$from.prd"
            clientFrameworks: "react"
            clientLanguages: "typescript"
        output:
          storeAs: figmaSpecs[]

  # PHASE 3: IMPLEMENTATION (Optional - if flagged)
  - id: implementation
    name: "Implementation - Build Components"
    type: implementation
    gateCondition: "{{parameters.withImplementation}}"
    errorRecovery: skip
    tasks:
      - id: implement_components
        agent: senior-frontend-engineer
        operation: delegate
        parallel: true
        input:
          context:
            figmaSpecs: "$from.figmaSpecs"
            prd: "$from.prd"
            componentIndex: "{{loop.index}}"
        output:
          storeAs: implementations[]

  # PHASE 4: VERIFICATION (Only if implementation runs)
  - id: verification
    name: "Verification - Type Check & Tests"
    type: verification
    gateCondition: "{{parameters.withImplementation}}"
    errorRecovery: skip
    tasks:
      - id: type_check
        agent: orchestrator
        operation: execute_command
        input:
          commands:
            - "npm run type-check"
        output:
          storeAs: typeCheckResult

      - id: run_tests
        agent: orchestrator
        operation: execute_command
        input:
          commands:
            - "npm run test:run"
        output:
          storeAs: testResult

      - id: visual_verification
        agent: playwright-dev-tester
        operation: delegate
        input:
          context:
            figmaSpecs: "$from.figmaSpecs"
            implementations: "$from.implementations"
        output:
          storeAs: visualTestResult

  # PHASE 5: INTEGRATION (Only if implementation runs)
  - id: integration
    name: "Integration - Mount Components in App"
    type: implementation
    gateCondition: "{{parameters.withImplementation}}"
    errorRecovery: skip
    tasks:
      - id: mount_components
        agent: orchestrator
        operation: mount_component
        input:
          components: "$from.implementations"
        output:
          storeAs: mountResult

  # PHASE 6: CLEANUP (Only if implementation runs)
  - id: cleanup
    name: "Cleanup - Remove Temporary Files"
    type: verification
    gateCondition: "{{parameters.withImplementation}}"
    errorRecovery: skip
    tasks:
      - id: cleanup_files
        agent: orchestrator
        operation: cleanup
        input:
          patterns:
            - "mcp/tests/temp-*.ts"
            - "mcp/tests/test-*.ts"
            - "mcp/tests/analyze-*.ts"
            - "docs/project/*-design-spec*.md"
        output:
          storeAs: cleanupResult

  # PHASE 7: COMPLETION
  - id: completion
    name: "Completion - Report Results"
    type: verification
    tasks:
      - id: report_completion
        agent: orchestrator
        operation: execute_command
        input:
          commands:
            - "echo '✅ PRD workflow complete!' && date"
        output:
          storeAs: completionLog
