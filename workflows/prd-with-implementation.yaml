name: prd-with-implementation
version: 1.0

phases:
  - id: prd
    tasks:
      - id: gen
        agent: prd-writer
        in: {reqs: "{{p.reqs}}"}
        out: prd

  - id: design
    gate: "{{p.urls != null && p.urls.length > 0}}"
    error: skip
    tasks:
      - id: analyze
        agent: figma-design-analyzer
        parallel: true
        in: {urls: "{{p.urls}}", prd: "$from.prd", fw: "react", lang: "ts"}
        out: "figmaSpecs[]"

  - id: impl
    gate: "{{p.impl}}"
    error: skip
    tasks:
      - id: build
        agent: senior-frontend-engineer
        parallel: true
        in: {specs: "$from.figmaSpecs", prd: "$from.prd", idx: "{{loop}}"}
        out: "impls[]"

  - id: verify
    gate: "{{p.impl}}"
    error: skip
    tasks:
      - id: type
        agent: orchestrator
        op: cmd
        in: {cmds: ["npm run type-check"]}
        out: typeRes

      - id: test
        agent: orchestrator
        op: cmd
        in: {cmds: ["npm run test:run"]}
        out: testRes

      - id: visual
        agent: playwright-dev-tester
        in: {specs: "$from.figmaSpecs", impls: "$from.impls"}
        out: visualRes

  - id: integrate
    gate: "{{p.impl}}"
    error: skip
    tasks:
      - id: mount
        agent: orchestrator
        op: mount
        in: {comps: "$from.impls"}
        out: mounted

  - id: cleanup
    gate: "{{p.impl}}"
    error: skip
    tasks:
      - id: clean
        agent: orchestrator
        op: cleanup
        in: {patterns: ["mcp/tests/temp-*", "docs/project/*-spec*.md"]}
        out: cleaned

  - id: done
    tasks:
      - id: report
        agent: orchestrator
        op: cmd
        in: {cmds: ["echo 'âœ… PRD workflow complete' && date"]}
        out: logged
